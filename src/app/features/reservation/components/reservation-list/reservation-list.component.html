<section [ngClass]="{ 'p-8 bg-gray-100 min-h-screen': !listOfDetailsField }">
  <div class="space-y-8 md:pb-0" [ngClass]="{ 'pb-12 ': !isFieldView && !listOfDetailsField }">
    @if (!listOfDetailsField) {
    <header class="bg-white p-6 rounded-xl shadow-md">
      <h1 class="text-2xl md:text-3xl font-bold text-primary">Tus reservas</h1>
      <p class="text-gray-600 mt-2 md:text-base text-sm">
        Aquí puedes ver todas tus reservas ordenadas a más recientes.
      </p>
    </header>
    } @if (loading) {
    <loading-component text="Cargando lista de reservas" />
    } @else { @if (!listOfDetailsField) {
    <div
      class="flex flex-col lg:flex-row w-full justify-between items-center lg:h-6 gap-y-3"
    >
      <button-action
        [text]="calendarView ? 'Ver como lista' : 'Ver como calendario'"
        [icon]="calendarView ? 'fa-solid fa-list' : 'fa-solid fa-calendar-days'"
        [hasIcon]="true"
        color="blue"
        (clicked)="toggleCalendarView()"
      >
      </button-action>
      @if (!calendarView) {
      <div
        class="flex flex-col md:flex-row gap-x-6 space-y-4 md:space-y-0 md:items-center w-full md:w-auto rounded-xl shadow-md md:shadow-none md:bg-transparent bg-white py-3 px-4 md:p-0"
      >
      <span
      class="font-semibold text-center justify-between flex items-center gap-2 cursor-pointer select-none"
      [class.cursor-pointer]="isSmallScreen"
      (click)="isSmallScreen && (showFilters = !showFilters)"
    >
      Filtros
      <i
        class="fa-solid transition-transform duration-200"
        [ngClass]="{
          'fa-chevron-up': isSmallScreen && showFilters,
          'fa-chevron-down': isSmallScreen && !showFilters,
        }"
      ></i>
    </span>
        <form
          [formGroup]="formFilter"
          (submit)="filter()"
          [ngClass]="{
            hidden: isSmallScreen && !showFilters,
            flex: true
          }"
          class="flex-col md:flex-row md:items-center gap-x-2 animate-fade-in"
        >
          <label class="block text-sm md:hidden my-2">Fecha de reserva</label>
          <input
            type="date"
            formControlName="reservationDate"
            placeholder="Fecha de reserva"
            class="w-full px-4 py-2 bg-gray-400/10 rounded-lg focus:outline-none focus:ring-1 focus:ring-green-400 transition-all duration-200"
          />
          <label class="block text-sm md:hidden my-2">Estado</label>
          <select
            formControlName="status"
            class="w-full px-4 py-2 bg-gray-400/10 rounded-lg focus:outline-none focus:ring-1 focus:ring-green-400 transition-all duration-200"
          >
            <option value="">Todas</option>
            <option value="ACTIVE">Activa</option>
            <option value="CANCELED">Cancelada</option>
            <option value="FINISHED">Finalizada</option>
          </select>
          <div
            class="flex items-center justify-start md:justify-center flex-row-reverse md:flex-row gap-2 mt-3 md:mt-0"
          >
            <button-action
              [text]="isSmallScreen ? 'Buscar' : ''"
              type="submit"
              [onlyIcon]="!isSmallScreen"
              icon="fa-solid fa-search"
              [hasIcon]="true"
              color="primary"
              title="Buscar reservas"
            ></button-action>

            <button-action
              [text]="isSmallScreen ? 'Limpiar' : ''"
              [onlyIcon]="!isSmallScreen"
              icon="fa-solid fa-eraser"
              [hasIcon]="true"
              color="red"
              (clicked)="cleanFilter()"
              title="Limpiar filtros"
            ></button-action>
          </div>
        </form>
      </div>
      }
    </div>
    } @if (reservationList.length > 0) { @if (!calendarView) { @if
    (!listOfDetailsField) {
    <h2 class="md:text-2xl text-lg font-semibold">Lista de reservas</h2>
    }
    <div
      class="grid gap-3"
      [ngClass]="
        listOfDetailsField
          ? 'grid-cols-1'
          : 'xl:grid-cols-3 lg:grid-cols-2 grid-cols-1'
      "
    >
      @for (reservation of reservationList; track reservation.id) {
      <article
        class="rounded-xl shadow-md hover:shadow-lg transition-all p-5 space-y-4 bg-white border border-gray-100 relative animate-slide-down overflow-hidden flex flex-col"
      >
        <!-- Cabecera -->
        <div class="flex justify-between items-start">
          <div class="space-y-1">
            <p
              class="text-xs text-gray-400 uppercase font-medium tracking-wide"
            >
              {{ isFieldView ? "Equipo" : "Cancha" }}
            </p>
            <h2
              class="text-base font-semibold text-primary truncate cursor-pointer hover:underline"
              (click)="
                reservationBy == 'field' || fromDetail == 'field'
                  ? openModal(reservation.team, 'team')
                  : openModal(reservation.field, 'field')
              "
            >
              {{
                isFieldView
                  ? reservation.team?.name || "Sin equipo asignado"
                  : reservation.field?.name || "Sin cancha asignada"
              }}
            </h2>
          </div>

          <span
            class="text-xs font-semibold px-3 py-1 rounded-full text-nowrap border truncate"
            [ngClass]="{
              'bg-green-50 text-green-700 border-green-200':
                reservation.status === StatusReservation.ACTIVE,
              'bg-gray-50 text-gray-700 border-gray-300':
                reservation.status === StatusReservation.FINISHED,
              'bg-red-50 text-red-700 border-red-200':
                reservation.status === StatusReservation.CANCELED
            }"
          >
            {{ reservation.status | statusReservation }}
          </span>
        </div>

        <!-- Detalles -->
        <div class="text-sm text-gray-600 flex-1">
          <div class="flex justify-between items-start gap-2">
            <div>
              <p>
                <span class="font-medium text-gray-800">Fecha:</span>
                {{ isReservationToday(reservation) }}
              </p>
              <p>
                <span class="font-medium text-gray-800">Hora:</span>
                {{ reservation.startTime | timeFormat }} -
                {{ reservation.endTime | timeFormat }}
              </p>
            </div>
            <div *ngIf="showButtons(reservation)" class="z-20 min-w-36">
              @switch(getReservationStatus(reservation)) { @case('upcoming') {
              <button-action
                text="Cancelar reserva"
                color="red"
                title="Cancelar esta reserva"
                (clicked)="cancelReservation(reservation.id)"
              />
              } @case('expired') {
              <button-action
                text="Finalizar reserva"
                color="black"
                title="Finalizar esta reserva"
                (clicked)="
                  finalizeReservation(reservation.id, reservation.team?.name)
                "
              />
              } @case('inProgress') { @if (reservationBy == 'field') {
              <button-action
                text="Finalizar reserva"
                color="black"
                title="Finalizar esta reserva"
                (clicked)="
                  finalizeReservation(reservation.id, reservation.team?.name)
                "
              />
              } } @case('other') {
              <button-action
                text="Cancelar reserva"
                color="red"
                title="Cancelar esta reserva"
                (clicked)="cancelReservation(reservation.id)"
              />
              } }
            </div>
          </div>
        </div>

        <!-- Estado dinámico -->
        <div *ngIf="reservation.status === StatusReservation.ACTIVE">
          <!-- Expirada -->
          <p
            *ngIf="isReservationExpired(reservation)"
            class="text-xs font-medium text-red-500 flex items-center gap-1"
          >
            <i class="fa-solid fa-circle-exclamation"></i>
            La reserva ha superado su hora final. Debe finalizarse.
          </p>

          <!-- Próxima -->
          <p
            *ngIf="getReservationStatus(reservation) === 'upcoming'"
            class="text-xs font-medium text-yellow-600 flex items-center gap-1"
          >
            <i class="fa-solid fa-clock"></i>
            Empieza pronto.
          </p>

          <!-- En curso -->
          <p
            *ngIf="isInProgressAndActive(reservation)"
            class="text-xs font-medium text-green-600 flex items-center gap-1"
          >
            <i class="fa-solid fa-futbol"></i>
            En curso.
          </p>
        </div>
        <!-- Imagen de fondo -->
        <img
          src="/assets/ball.webp"
          class="absolute z-10 w-64 -bottom-40 -right-20 opacity-20"
          alt=""
        />
      </article>
      }
    </div>
    } @else {
    <div class="animate-slide-down">
      <app-reservation-calendar
        [reservationList]="reservationList"
        [reservationBy]="reservationBy"
      >
      </app-reservation-calendar>
    </div>
    } } @else {
    <p class="text-gray-600" [ngClass]="{ 'px-3': !listOfDetailsField }">
      No se encontró ninguna reserva.
    </p>
    } } @if (isReservationTeam()) {
    <button-action
      [className]="'fixed bottom-20 md:bottom-8 right-8 z-20'"
      [hasIcon]="true"
      icon="fa-solid fa-plus"
      [text]="'Hacer nueva reserva'"
      title="Hacer nueva reserva"
      color="primary"
      [bigButton]="isSmallScreen"
      (clicked)="makeReservation()"
    />
    }
  </div>
</section>

<!-- Modal equipo -->
@if (showModal && selectedItem) {
<div
  class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm transition-all px-3"
>
  <div
    class="bg-white w-full max-w-md mx-auto rounded-2xl p-6 relative shadow-2xl animate-fade-in"
  >
    <button
      (click)="closeModal()"
      class="absolute top-2 right-4 text-gray-400 hover:text-red-500 text-xl"
    >
      &times;
    </button>

    <h2 class="text-2xl font-bold text-primary mb-4">
      {{ selectedItem.name }}
    </h2>

    @switch (selectedType) { @case ('team') {
    <div class="space-y-2 text-sm text-gray-700">
      <p>
        <span class="font-medium">Ciudad:</span>
        {{ selectedItem.city || "No definida" }}
      </p>
      <p>
        <span class="font-medium">Barrio:</span>
        {{ selectedItem.neighborhood || "No definido" }}
      </p>
    </div>
    } @case ('field') {
    <div class="space-y-2 text-sm text-gray-700">
      <p>
        <span class="font-medium">Dirección:</span>
        {{ selectedItem.address || "No definida" }}
      </p>
      <p>
        <span class="font-medium">Ciudad:</span>
        {{ selectedItem.city || "No definida" }}
      </p>
      <p>
        <span class="font-medium">Precio por hora:</span>
        {{ selectedItem.hourlyRate | moneyFormat }}
      </p>
      <p>
        <span class="font-medium">Horario:</span>
        {{ selectedItem.openingHour | timeFormat }} -
        {{ selectedItem.closingHour | timeFormat }}
      </p>
    </div>
    } }
  </div>
</div>
}
